<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1>üß™ –¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞</h1>
        
        <div style="margin-bottom: 20px;">
            <label>JWT —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label><br>
            <input type="text" id="tokenInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ JWT —Ç–æ–∫–µ–Ω" style="width: 500px; padding: 8px;">
            <button onclick="connectToChat()" style="padding: 8px 16px; margin-left: 10px;">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
        
        <div id="status" style="margin-bottom: 20px; font-weight: bold;">
            –°—Ç–∞—Ç—É—Å: ‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
        </div>
        
        <div id="messages" style="height: 300px; border: 1px solid #ccc; padding: 10px; overflow-y: auto; margin-bottom: 20px; background: #f9f9f9;">
            <div style="color: #666;">–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1; padding: 8px;" disabled>
            <button onclick="sendMessage()" id="sendBtn" style="padding: 8px 16px;" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button onclick="loadHistory()" id="historyBtn" style="padding: 8px 16px;" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 5px;">
            <strong>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong>
            <ol>
                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ JWT —Ç–æ–∫–µ–Ω –∏–∑ localStorage –≤–∞—à–µ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞</li>
                <li>–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–æ–ª–µ –≤—ã—à–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"</li>
                <li>–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</li>
                <li>–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ Strapi</li>
            </ol>
        </div>
        
        <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 5px;">
            <strong>üîç –û—Ç–ª–∞–¥–∫–∞:</strong><br>
            –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Console –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        </div>
    </div>

    <script>
        let socket = null;
        let isConnected = false;

        function addMessage(text, isSystem = false) {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.style.marginBottom = '8px';
            messageEl.style.padding = '8px';
            messageEl.style.borderRadius = '8px';
            
            if (isSystem) {
                messageEl.style.background = '#e3f2fd';
                messageEl.style.color = '#1976d2';
                messageEl.style.fontStyle = 'italic';
            } else {
                messageEl.style.background = '#fff';
                messageEl.style.border = '1px solid #ddd';
            }
            
            messageEl.innerHTML = `
                <strong>${new Date().toLocaleTimeString()}:</strong> ${text}
            `;
            
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateStatus(status, color) {
            document.getElementById('status').innerHTML = `–°—Ç–∞—Ç—É—Å: ${status}`;
            document.getElementById('status').style.color = color;
        }

        function connectToChat() {
            const token = document.getElementById('tokenInput').value.trim();
            
            if (!token) {
                alert('–í–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω!');
                return;
            }

            console.log('üîå –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket —Å —Ç–æ–∫–µ–Ω–æ–º:', token.substring(0, 10) + '...');
            addMessage('üîå –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket...', true);

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (socket) {
                socket.close();
            }

            socket = io('http://localhost:1337', {
                auth: { token: token },
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ WebSocket');
                isConnected = true;
                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω', 'green');
                addMessage('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —á–∞—Ç—É!', true);
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('historyBtn').disabled = false;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
                setTimeout(() => {
                    console.log('üß™ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ');
                    socket.emit('test', { message: '—Ç–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' });
                }, 1000);
            });

            socket.on('disconnect', () => {
                console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç WebSocket');
                isConnected = false;
                updateStatus('‚ùå –û—Ç–∫–ª—é—á–µ–Ω', 'red');
                addMessage('‚ùå –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —á–∞—Ç–∞', true);
                
                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('historyBtn').disabled = true;
            });

            socket.on('newMessage', (message) => {
                console.log('üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
                const prefix = message.isFromSupport ? 'üë®‚Äçüíº –ü–æ–¥–¥–µ—Ä–∂–∫–∞' : 'üë§ –í—ã';
                addMessage(`${prefix}: ${message.text}`);
            });

            socket.on('messageHistory', (data) => {
                console.log('üìú –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', data);
                addMessage(`üìú –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏`, true);
                
                data.messages.forEach(message => {
                    const prefix = message.isFromSupport ? 'üë®‚Äçüíº –ü–æ–¥–¥–µ—Ä–∂–∫–∞' : 'üë§ –í—ã';
                    addMessage(`${prefix}: ${message.text}`);
                });
            });

            socket.on('error', (error) => {
                console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
                addMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message || error}`, true);
            });

            socket.on('test', (data) => {
                console.log('üß™ –ü–æ–ª—É—á–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
                addMessage(`üß™ –¢–µ—Å—Ç: ${data.message}`, true);
            });

            socket.on('test-response', (data) => {
                console.log('üß™ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–µ—Å—Ç:', data);
                addMessage(`üß™ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${data.message} (ID: ${data.userId})`, true);
            });

            socket.on('connect_error', (error) => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                addMessage(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, true);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'red');
            });
        }

        function sendMessage() {
            const messageText = document.getElementById('messageInput').value.trim();
            
            if (!messageText || !socket || !isConnected) {
                console.log('‚ùå –ù–µ –º–æ–≥—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }

            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ:', messageText);
            addMessage('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ...', true);

            socket.emit('message', {
                text: messageText,
                isFromSupport: false
            });

            document.getElementById('messageInput').value = '';
        }

        function loadHistory() {
            if (!socket || !isConnected) {
                console.log('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏');
                return;
            }

            console.log('üìú –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π');
            addMessage('üìú –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π...', true);
            
            socket.emit('getMessages', {});
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html> 