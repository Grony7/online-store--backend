# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É –æ–Ω–ª–∞–π–Ω-—á–∞—Ç–∞ –≤ Strapi 5

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

1. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `socket.io`, `jsonwebtoken`, `@types/jsonwebtoken`
2. ‚úÖ –°–æ–∑–¥–∞–Ω Content Type "Message" —Å –ø–æ–ª—è–º–∏:
   - `userId` (String)
   - `text` (Text)
   - `isFromSupport` (Boolean)
   - `user` (Relation –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
3. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω WebSocket —Å–µ—Ä–≤–µ—Ä –≤ `src/index.ts`
4. ‚úÖ –°–æ–∑–¥–∞–Ω—ã API endpoints –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
5. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
6. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω CORS –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
7. ‚úÖ –°–æ–∑–¥–∞–Ω –ø—Ä–∏–º–µ—Ä React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Å –∫—Ä–∞—Å–∏–≤—ã–º UI

## üîß –®–∞–≥–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à `.env` —Ñ–∞–π–ª:

```env
# Frontend URL –¥–ª—è CORS –∏ WebSocket
FRONTEND_URL=http://localhost:3000

# JWT Secret (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
JWT_SECRET=your-super-secret-jwt-key-here

# Chat –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
CHAT_ENABLED=true
```

### 2. –ó–∞–ø—É—Å–∫ Strapi

```bash
# –ï—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω
npm run develop
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π –≤ –∞–¥–º–∏–Ω–∫–µ Strapi

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É Strapi: http://localhost:1337/admin
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Settings** ‚Üí **Users & Permissions Plugin** ‚Üí **Roles**
3. –î–ª—è —Ä–æ–ª–∏ **Authenticated**:
   - –ù–∞–π–¥–∏—Ç–µ **Message** –≤ —Å–ø–∏—Å–∫–µ
   - –í–∫–ª—é—á–∏—Ç–µ –ø—Ä–∞–≤–∞: `create`, `find`, `findOne`
4. –°–æ–∑–¥–∞–π—Ç–µ —Ä–æ–ª—å **Support** (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞):
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∞–≤–∞ –æ—Ç **Authenticated**
   - –î–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è **Message**: `update`, `delete`

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ:

```bash
npm install socket.io-client
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:

```jsx
import React from 'react';
import Chat from './components/Chat';

function App() {
  // –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const userToken = localStorage.getItem('jwt'); // –∏–ª–∏ –∏–∑ Redux/Context
  const userId = localStorage.getItem('userId'); // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  
  return (
    <div className="App">
      <Chat 
        userToken={userToken}
        userId={userId}
        isSupport={false} // true –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏
      />
    </div>
  );
}

export default App;
```

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:

–°–æ–∑–¥–∞–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ React –ø—Ä–æ–µ–∫—Ç–∞:

```env
REACT_APP_API_URL=http://localhost:1337
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ REST API

```bash
# –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∑–∞–º–µ–Ω–∏—Ç–µ USER_ID –∏ JWT_TOKEN)
curl -X GET "http://localhost:1337/api/messages/user/USER_ID" \
  -H "Authorization: Bearer JWT_TOKEN"

# –°–æ–∑–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
curl -X POST "http://localhost:1337/api/messages" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer JWT_TOKEN" \
  -d '{
    "data": {
      "text": "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
      "isFromSupport": false
    }
  }'
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ WebSocket

–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```javascript
// –í–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–∫—É WebSocket
localStorage.debug = 'socket.io-client:socket';

// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏:

1. **isAuthenticated** - –ø—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞
2. **isOwnerOrSupport** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

### WebSocket –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:

- –í—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç –≤–∞–ª–∏–¥–Ω—ã–π JWT —Ç–æ–∫–µ–Ω
- –¢–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `auth.token` –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—é—Ç—Å—è –∫ —Å–≤–æ–µ–π –∫–æ–º–Ω–∞—Ç–µ

## üì° API Reference

### REST Endpoints

| –ú–µ—Ç–æ–¥ | URL | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|-----|----------|
| GET | `/api/messages/user/:userId` | –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| POST | `/api/messages` | –°–æ–∑–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ |
| GET | `/api/messages` | –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∞–¥–º–∏–Ω) |

### WebSocket Events

#### –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è:

- `join` - –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ (—Å–∞–ø–ø–æ—Ä—Ç)
- `message` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
- `getMessages` - –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π

#### –ü–æ–ª—É—á–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è:

- `newMessage` - –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- `messageHistory` - –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- `error` - –æ—à–∏–±–∫–∞

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:

Strapi –≤—ã–≤–æ–¥–∏—Ç –ª–æ–≥–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:
- `üöÄ CHAT:` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
- `üë§ CHAT:` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è
- `üí¨ CHAT:` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- `üîí CHAT:` - –æ—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –õ–æ–≥–∏ –∫–ª–∏–µ–Ω—Ç–∞:

```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
localStorage.debug = 'socket.io-client:socket';
```

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **CORS –æ—à–∏–±–∫–∏**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `FRONTEND_URL` –≤ `.env`
2. **JWT –æ—à–∏–±–∫–∏**: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π –∏ –Ω–µ –∏—Å—Ç–µ–∫
3. **WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Strapi –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—Ç—É

## üöÄ –ü—Ä–æ–¥–∞–∫—à–Ω

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞:

```env
NODE_ENV=production
FRONTEND_URL=https://your-frontend-domain.com
JWT_SECRET=your-super-secure-production-jwt-secret
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∫—Å–∏ (nginx):

```nginx
location /socket.io/ {
    proxy_pass http://localhost:1337;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Strapi –≤ –∫–æ–Ω—Å–æ–ª–∏
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network tab –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ –∞–¥–º–∏–Ω–∫–µ Strapi

---

**–ì–æ—Ç–æ–≤–æ! üéâ** –í–∞—à –æ–Ω–ª–∞–π–Ω-—á–∞—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! 